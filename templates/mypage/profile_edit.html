{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/mypage/profile_edit.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Hubballi&display=swap" rel="stylesheet">
<style>
    @media screen and (max-width: 768px) {
        .form-container {
            width: 600px; 
        }

        .form-input, .form-textarea {
            padding: 12px;
            font-size: 1rem; 
        }

        .form-button {
            padding: 15px;
            font-size: 1rem;
        }

        .upload-label {
            width: 120px;
            height: 120px;
            cursor: pointer;
        }

        .remove-image {
            font-size: 1rem;
        }
    }

    @media screen and (max-width: 480px) {
        .form-container {
            width: 400px; 
            padding: 15px; 
        }

        .upload-label {
            width: 100px;
            height: 100px; 
        }
    }
</style>
<div class="form-container">
    <div class="logo">
        <img src="{% static 'images/logo.svg' %}" alt="PiroTime Logo" width="170" height="170">
        <h1>PiroTime</h1>
    </div>

    <form method="post" action="{% url 'mypage:profile_edit' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="form-group">
            <label for="id_username">사용자 이름</label>
            {{ form.username }}
            {% if form.username.errors %}
                <div class="error">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_email">이메일 주소</label>
            {{ form.email }}
            {% if form.email.errors %}
                <div class="error">{{ form.email.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_nickname">닉네임</label>
            {{ form.nickname }}
            {% if form.nickname.errors %}
                <div class="error">{{ form.nickname.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group image-upload">
            <div class="image-label-wrapper">
                <span>프로필 이미지 (선택)</span>
                <button type="button" class="remove-image" onclick="removeImage()">이미지 삭제</button>
            </div>
            <div class="upload-label" onclick="document.getElementById('id_profile_image').click();">
                {% if user.profile_image %}
                    <img id="image-preview" src="{{ user.profile_image.url }}" alt="프로필 이미지 미리보기" class="profile-image">
                {% else %}
                    <i class="fas fa-camera"></i>
                    <img id="image-preview" alt="프로필 이미지 미리보기" style="display:none;">
                {% endif %}
            </div>
            <input type="file" name="profile_image" id="id_profile_image" accept="image/*" class="form-input--img" onchange="previewImage(event)" style="display:none;">
            <input type="hidden" name="delete_profile_image" id="id_delete_profile_image" value="false">
        </div>
        {% if form.profile_image.errors %}
            <div class="error">{{ form.profile_image.errors }}</div>
        {% endif %}

        <div class="form-group">
            <label for="id_cohort">기수</label>
            {{ form.cohort }}
            {% if form.cohort.errors %}
                <div class="error">{{ form.cohort.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_intro">소개</label>
            {{ form.intro }}
            {% if form.intro.errors %}
                <div class="error">{{ form.intro.errors }}</div>
            {% endif %}
        </div>

        <button type="submit" class="form-button">저장</button>
    </form>
</div>

<script>
    function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function() {
            const output = document.getElementById('image-preview');
            const cameraIcon = document.querySelector('.upload-label i');
            const removeBtn = document.querySelector('.remove-image');
            
            // 이미지 미리보기 설정
            output.src = reader.result;
            output.style.display = 'block';
            
            // 카메라 아이콘 숨기기
            if (cameraIcon) {
                cameraIcon.style.display = 'none';
            }

            // 삭제 버튼 보이기
            removeBtn.style.display = 'inline-block';
        }
        reader.readAsDataURL(event.target.files[0]);
    }

    function removeImage() {
        const output = document.getElementById('image-preview');
        const cameraIcon = document.querySelector('.upload-label i');
        const removeBtn = document.querySelector('.remove-image');
        const fileInput = document.getElementById('id_profile_image');
        const deleteImageInput = document.getElementById('id_delete_profile_image');

        // 이미지 src를 제거하고 이미지 숨기기
        output.removeAttribute('src');
        output.style.display = 'none';

        // 카메라 아이콘 보이기
        if (cameraIcon) {
            cameraIcon.style.display = 'block';
        }

        // 삭제 버튼 숨기기
        removeBtn.style.display = 'none';

        // 파일 입력 초기화
        fileInput.value = ""; 

        // 이미지 삭제 의도 전송
        deleteImageInput.value = "true";
    }

    // 페이지 로드 시 프로필 이미지가 있으면 삭제 버튼을 표시
    window.onload = function() {
        const output = document.getElementById('image-preview');
        const removeBtn = document.querySelector('.remove-image');
        const cameraIcon = document.querySelector('.upload-label i');
        
        // 프로필 이미지가 있으면 삭제 버튼 보이기
        if (output.src && !output.src.includes('data:') && output.src !== '') {
            removeBtn.style.display = 'inline-block';
            output.style.display = 'block'; // 이미지가 있는 경우 이미지를 보이게 설정
            if (cameraIcon) {
                cameraIcon.style.display = 'none'; // 아이콘 숨기기
            }
        } else {
            if (cameraIcon) {
                cameraIcon.style.display = 'block'; // 아이콘 보이기
            }
            removeBtn.style.display = 'none'; // 삭제 버튼 숨기기
            output.style.display = 'none'; // 이미지 숨기기
        }
    };
</script>
{% endblock %}
