{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/trend/trend_detail.css' %}"> <!-- Changed from review to trend -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- CSRF 토큰을 메타 태그로 삽입 -->
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="container">
  <div class="trend-detail"> <!-- Changed from review-detail to trend-detail -->
    <div class="header-section">
      <div class="image-placeholder">
        <img src="{% static 'images/logo.svg' %}" alt="Trend Image" class="trend-image"> <!-- Changed alt text -->
      </div>
      <div class="header-details">
        <h1>{{ trend.title }}</h1> <!-- Changed from review to trend -->
        <h2>{{ trend.subtitle }}</h2> <!-- Changed from review to trend -->
        <div class="meta-info">
          <span><i class="fas fa-user"></i> {{ trend.writer }}</span> <!-- Changed from review to trend -->
          <span><i class="fas fa-calendar-alt"></i> {{ trend.date }}</span> <!-- Changed from review to trend -->
        </div>
      </div>
    </div>

    <hr class="section-divider">

    <div class="content-section">
      <div class="sidebar">
        <div class="about-box">
          <h3>About</h3>
          <div class="action-buttons">
            <button class="btn-action btn-like {% if user in trend.likes.all %}liked{% endif %}" data-trend-id="{{ trend.id }}"> <!-- Changed from review to trend -->
              <i class="fas fa-heart"></i>
              <span class="like-count">{{ trend.likes.count }}</span> <!-- Changed from review to trend -->
            </button>
            <button class="btn-action btn-bookmark {% if user in trend.bookmarks.all %}bookmarked{% endif %}" data-trend-id="{{ trend.id }}"> <!-- Changed from review to trend -->
              <i class="fas fa-bookmark"></i>
            </button>
            <a href="{{ trend.giturl }}" class="btn-action btn-github" target="_blank"> <!-- Changed from review to trend -->
              <i class="fab fa-github"></i>
            </a>
          </div>
        </div>
      </div>
      <div class="main-content">
        {{ trend.content|safe }} <!-- Changed from review to trend -->
      </div>
    </div>

    <hr class="section-divider">

    <div class="comment-section">
      <h3>댓글</h3>
      <div class="comments">
        {% for comment in comments %}
          <div class="comment">
            <p>{{ comment.content }}</p>
            <div class="comment-meta">
              <span><i class="fas fa-user"></i> {{ comment.writer }}</span>
              <span><i class="fas fa-calendar-alt"></i> {{ comment.date }}</span>
              {% if comment.writer == user or user.is_staff %}
                <button class="btn-delete-comment" data-comment-id="{{ comment.id }}">
                  <i class="fas fa-trash-alt"></i> 삭제
                </button>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>댓글이 없습니다. 첫 번째 댓글을 남겨보세요!</p>
        {% endfor %}
      </div>
      <form class="comment-form" method="post" action="{% url 'trend:add_comment' trend.id %}"> <!-- Changed from review to trend -->
        {% csrf_token %}
        <textarea class="comment-input" name="content" placeholder="댓글을 입력하세요..." required></textarea>
        <button type="submit" class="btn-add-comment">등록</button>
      </form>
    </div>
  </div>
  <div class="action-buttons-bottom">
    <a href="{% url 'trend:trend_list' %}" class="btn-action btn-back"> <!-- Changed from review to trend -->
      <i class="fas fa-arrow-left"></i> 트렌드 목록으로 돌아가기 <!-- Changed link text -->
    </a>
    {% if user.username == trend.writer.username or user.is_staff %} <!-- Changed from review to trend -->
      <a href="{% url 'trend:trend_update' trend.id %}" class="btn-action btn-edit"> <!-- Changed from review to trend -->
        <i class="fas fa-edit"></i> 수정
      </a>
      <form method="post" action="{% url 'trend:trend_delete' trend.id %}" style="display: inline;"> <!-- Changed from review to trend -->
        {% csrf_token %}
        <button type="submit" class="btn-action btn-delete" onclick="return confirm('정말로 이 트렌드를 삭제하시겠습니까?');"> <!-- Changed confirmation text -->
          <i class="fas fa-trash-alt"></i> 삭제
        </button>
      </form>
    {% endif %}
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    // CSRF 토큰 가져오기
    function getCSRFToken() {
      return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // AJAX 설정
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
        }
      }
    });

    // 좋아요 기능
    $('.btn-like').click(function() {
      var trendId = $(this).data('trend-id'); // Changed from review to trend
      var likeButton = $(this);
      $.post('/trend/' + trendId + '/like/', { // Changed from review to trend
        csrfmiddlewaretoken: getCSRFToken()
      }, function(data) {
        if (data.liked) {
          likeButton.addClass('liked');
        } else {
          likeButton.removeClass('liked');
        }
        likeButton.find('.like-count').text(data.total_likes); // 좋아요 수 업데이트
      }).fail(function(xhr, status, error) {
        // 로그인 리다이렉션 확인
        if (xhr.status == 302) {
          window.location.href = xhr.getResponseHeader('Location');
        } else {
          alert('좋아요 요청에 실패했습니다. 다시 시도해주세요.');
        }
      });
    });

    // 북마크 기능
    $('.btn-bookmark').click(function() {
      var trendId = $(this).data('trend-id'); // Changed from review to trend
      var bookmarkButton = $(this);
      $.post('/trend/' + trendId + '/bookmark/', { // Changed from review to trend
        csrfmiddlewaretoken: getCSRFToken()
      }, function(data) {
        if (data.bookmarked) {
          bookmarkButton.addClass('bookmarked');
        } else {
          bookmarkButton.removeClass('bookmarked');
        }
      }).fail(function(xhr, status, error) {
        // 로그인 리다이렉션 확인
        if (xhr.status == 302) {
          window.location.href = xhr.getResponseHeader('Location');
        } else {
          alert('북마크 요청에 실패했습니다. 다시 시도해주세요.');
        }
      });
    });

    // 댓글 삭제 기능
    $('.btn-delete-comment').click(function() {
      var commentId = $(this).data('comment-id');
      if (confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
        $.ajax({
          url: '/trend/comment/' + commentId + '/delete/', // Changed from review to trend
          type: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken() // CSRF 토큰 추가
          },
          success: function() {
            location.reload();
          },
          error: function(xhr, status, error) {
            // 로그인 리다이렉션 확인
            if (xhr.status == 302) {
              window.location.href = xhr.getResponseHeader('Location');
            } else {
              alert('댓글 삭제에 실패했습니다. 다시 시도해주세요.');
            }
          }
        });
      }
    });
  });
</script>

{% endblock %}